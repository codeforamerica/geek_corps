<% @team.app.milestones.group_by(&:goal).each do |key, value| %>
  <ul class="group">
    <li>
    <h3 id="group_<%= key %>">
      <%= truncate(goal_name(key), :length => 35, :separator => ' ') %>
    </h3>
    <div>
      <ul>
        <% value.each do |milestone| %>
          <li  class="milestone">
          <h4 id="milestone_<%= milestone.id %>">
            <%= link_to truncate(milestone.name, :length => 35, :separator => ' '), team_milestone_path(@team.name, milestone.id) %>
          </h4>
          <div>
            <ol>
              <% milestone.steps.each do |step| %>
                <li id="step_<%= step.id %>" class="step">
                <h5>
                  <%=link_to truncate(step.name, :length => 35, :separator => ' '), team_step_path(@team.name, step)%>
                </h5>
                </li>
              <% end %>
            </ol>
            <%= link_to "Add a Step", team_step_new_path(@team.name, :milestone => milestone)%>
          </div>
          </li>
        <% end %>
      </ul>
      <%= link_to "Add a Milestone", team_milestone_new_path(@team.name, :goal => key)%> 
    </div>
    </li>
  </ul>
<% end %>
<script>
  jQuery(document).ready(function(){
    
    $('h3,h4').click(function() {
      var closed = [];
      $(this).toggleClass('collapsed');
//      console.log($(this).parents('ul')[0]);
      $(this).next().slideToggle('slow', function() {
        $('h3.collapsed, h4.collapsed').each(function(idx, el) {
          closed.push(el.id);
        });
//        console.log(closed);
      });
      return false;
    });
  });
</script>
